<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Volume Clamping - Custom AudioWorklet Demo</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>

  <body>
    <!-- Left Panel with Controls -->
    <div id="leftPanel">
      <h2>Controls</h2>

      <h3>Volume Ceiling</h3>
      <label>
        <span>Maximum Volume (dB)</span>
        <input id="threshold" type="range" min="-60" max="0" step="1" value="-20" />
        <span class="value-display" id="thresholdVal">-20</span>
        <p class="description">
          Sets the maximum volume ceiling. Any audio louder than this will be clamped down to this level.
        </p>
      </label>

      <h3>Advanced Parameters</h3>
      <details open>
        <summary>Fine-Tuning Controls</summary>

        <label>
          <span>Attack Time (ms)</span>
          <input id="attackTime" type="range" min="1" max="50" step="1" value="15" />
          <span class="value-display" id="attackTimeVal">15</span>
          <p class="description">
            How quickly gain reduction is applied (faster = more aggressive limiting).
          </p>
        </label>

        <label>
          <span>Release Time (ms)</span>
          <input id="releaseTime" type="range" min="20" max="500" step="10" value="80" />
          <span class="value-display" id="releaseTimeVal">80</span>
          <p class="description">
            How quickly gain is restored after limiting (slower = smoother, more natural).
          </p>
        </label>

        <label>
          <span>RMS Window (ms)</span>
          <input id="rmsWindow" type="range" min="1" max="20" step="1" value="5" />
          <span class="value-display" id="rmsWindowVal">5</span>
          <p class="description">
            Level detection window size (smaller = faster response, larger = smoother).
          </p>
        </label>

        <button id="resetDefaults" class="toggle-button" style="width: 100%;">
          Reset to Defaults
        </button>
      </details>
    </div>

    <!-- Main Content -->
    <div id="mainContent">
      <h1>Volume Clamping - Custom AudioWorklet Demo</h1>

      <audio controls>
        <source src="media/loud-test.mp3" type="audio/mpeg" />
        <p>This demo needs a browser supporting the &lt;audio&gt; element.</p>
      </audio>

      <div style="display: flex; gap: 10px; align-items: center; margin: 20px 0;">
        <button id="toggleProcessing" class="toggle-button enabled">Processing: ON</button>
        <button id="exportData" class="toggle-button disabled" disabled>Export CSV</button>
        <button id="resetChart" class="toggle-button">Reset Chart</button>
        <span id="statusMessage" style="font-size: 0.9em; color: #666;"></span>
      </div>

      <div id="visualizer">
        <div class="graph-container">
          <canvas id="audioChart"></canvas>
        </div>
        <div class="stats-container">
          <div class="stat-box">
            <div class="stat-label">Input Level</div>
            <div class="stat-value input" id="inputValue">-∞ dB</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Output Level</div>
            <div class="stat-value output" id="outputValue">-∞ dB</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Reduction</div>
            <div class="stat-value reduction" id="reductionDisplay">0%</div>
          </div>
        </div>
      </div>
    </div>

    <script src="src/audio-processor.js"></script>
    <script src="src/audio-visualizer.js"></script>
    <script>
      const audioElt = document.querySelector("audio");

      let audioCtx = null;
      let sourceNode = null;

      const processor = new VoiceVolumeNormalizer(-20);
      const visualizer = new AudioVisualizer(processor, audioElt);

      let processingEnabled = true; // Track processing state
      let dbClampThreshold = -20; // Store user's chosen threshold

      function formatDb(db) {
        if (db === -Infinity) return '  -∞ dB';
        return db.toFixed(1).padStart(6) + ' dB';
      }

      const ui = {
        toggleProcessing: document.getElementById("toggleProcessing"),
        exportData: document.getElementById("exportData"),
        statusMessage: document.getElementById("statusMessage"),
        threshold: document.getElementById("threshold"),
        thresholdVal: document.getElementById("thresholdVal"),
        attackTime: document.getElementById("attackTime"),
        attackTimeVal: document.getElementById("attackTimeVal"),
        releaseTime: document.getElementById("releaseTime"),
        releaseTimeVal: document.getElementById("releaseTimeVal"),
        rmsWindow: document.getElementById("rmsWindow"),
        rmsWindowVal: document.getElementById("rmsWindowVal"),
        resetDefaults: document.getElementById("resetDefaults"),
        resetChart: document.getElementById("resetChart"),
        reductionDisplay: document.getElementById("reductionDisplay"),
        inputValue: document.getElementById("inputValue"),
        outputValue: document.getElementById("outputValue"),
      };

      visualizer.onMetersUpdate = (data) => {
        ui.inputValue.textContent = formatDb(data.inputDb);
        ui.outputValue.textContent = formatDb(data.outputDb);

        if (data.reductionPercent !== undefined) {
          ui.reductionDisplay.textContent = data.reductionPercent.toFixed(1) + '%';
        }
      };

      // Update chart duration when audio metadata loads
      audioElt.addEventListener("loadedmetadata", () => {
        visualizer.updateAudioDuration();
      });

      audioElt.addEventListener("play", async () => {
        // Reset chart when replaying audio
        if (audioCtx && audioElt.currentTime === 0) {
          visualizer.resetChart();
        }

        if (!audioCtx) {
          try {
            audioCtx = new AudioContext();
            sourceNode = audioCtx.createMediaElementSource(audioElt);

            ui.statusMessage.textContent = "⏳ Loading AudioWorklet...";
            ui.statusMessage.style.color = "#3498db";

            await processor.initialize(audioCtx);

            // Always enable processor (needed for visualizer)
            processor.enable(sourceNode, audioCtx.destination);

            // Set threshold based on processing state
            if (!processingEnabled) {
              processor.updateParameters({ threshold: 0 }); // 0 dB = no limiting
            }

            // Always start visualizer
            visualizer.start();

            ui.statusMessage.textContent = "✓ AudioWorklet loaded";
            ui.statusMessage.style.color = "#27ae60";

            setTimeout(() => {
              ui.statusMessage.textContent = "";
            }, 2000);
          } catch (error) {
            console.error('[Init] Failed to initialize audio processor:', error);
            ui.statusMessage.textContent = "❌ AudioWorklet failed to load. Are you running from a web server?";
            ui.statusMessage.style.color = "#e74c3c";
            return;
          }
        }

        // Restart visualization if it was paused
        if (processor.isActive && !visualizer.animationId) {
          visualizer.start();
        }

        if (!visualizer.isRecording) {
          visualizer.startRecording();
          ui.exportData.disabled = false;
          ui.exportData.classList.remove("disabled");
          ui.exportData.classList.add("enabled");
        }
      });

      audioElt.addEventListener("pause", () => {
        // Pause the visualization loop when audio is paused
        visualizer.pause();
      });

      audioElt.addEventListener("ended", () => {
        // Pause the visualization loop when audio ends (keep data visible)
        visualizer.pause();
      });

      ui.toggleProcessing.onclick = () => {
        if (ui.toggleProcessing.classList.contains("enabled")) {
          // Turn OFF - set threshold to 0 dB (no limiting)
          processingEnabled = false;
          processor.updateParameters({ threshold: 0 });
          ui.toggleProcessing.textContent = "Processing: OFF";
          ui.toggleProcessing.classList.remove("enabled");
          ui.toggleProcessing.classList.add("disabled");
        } else {
          // Turn ON - restore user's threshold
          processingEnabled = true;
          processor.updateParameters({ threshold: dbClampThreshold });
          ui.toggleProcessing.textContent = "Processing: ON";
          ui.toggleProcessing.classList.remove("disabled");
          ui.toggleProcessing.classList.add("enabled");
        }
      };

      ui.exportData.onclick = () => {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        visualizer.exportRecordingData(`audio-diagnostics-${timestamp}.csv`);
        ui.statusMessage.textContent = "✓ Data exported";
        ui.statusMessage.style.color = "#27ae60";
        setTimeout(() => {
          ui.statusMessage.textContent = "";
        }, 3000);
      };

      ui.threshold.oninput = () => {
        dbClampThreshold = parseFloat(ui.threshold.value);
        if (processingEnabled) {
          processor.updateParameters({ threshold: dbClampThreshold });
        }
        ui.thresholdVal.textContent = ui.threshold.value;
      };

      ui.attackTime.oninput = () => {
        processor.updateParameters({ attackTime: parseFloat(ui.attackTime.value) });
        ui.attackTimeVal.textContent = ui.attackTime.value;
      };

      ui.releaseTime.oninput = () => {
        processor.updateParameters({ releaseTime: parseFloat(ui.releaseTime.value) });
        ui.releaseTimeVal.textContent = ui.releaseTime.value;
      };

      ui.rmsWindow.oninput = () => {
        processor.updateParameters({ rmsWindow: parseFloat(ui.rmsWindow.value) });
        ui.rmsWindowVal.textContent = ui.rmsWindow.value;
      };

      ui.resetDefaults.onclick = () => {
        ui.threshold.value = -20;
        ui.thresholdVal.textContent = "-20";
        ui.attackTime.value = 15;
        ui.attackTimeVal.textContent = "15";
        ui.releaseTime.value = 80;
        ui.releaseTimeVal.textContent = "80";
        ui.rmsWindow.value = 5;
        ui.rmsWindowVal.textContent = "5";

        dbClampThreshold = -20;

        processor.updateParameters({
          threshold: processingEnabled ? -20 : 0,
          attackTime: 15,
          releaseTime: 80,
          rmsWindow: 5
        });
      };

      ui.resetChart.onclick = () => {
        visualizer.resetChart();
      };
    </script>
  </body>
</html>
